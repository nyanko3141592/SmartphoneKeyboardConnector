# 1) 入力モデル（イベント仕様）

- ## キー形状

  - 3×4 のかなキーグリッド＋機能キー（スペース・削除・確定などは別領域）。
  - 各キーは **5 入力** を持つ：中央タップ（a）＋ 4 方向フリック（↑i / →u / ↓e / ←o）。

- ## ジェスチャ判定

  - `touchstart` で基準点を記録。
  - `touchend` でベクトル `v` を計算。

    - しきい値：|v| < `R`（例：キー幅の 0.28）→ 中央タップ扱い。
    - 角度を 4 象限に量子化（±45° の扇形推奨）して上下左右を決定。

- ## 長押し（optional だが便利）

  - 500ms 以上の押下で **ポップアップ**：

    - その行の小書き（小/拗音）、**濁点「゛」**、**半濁点「゜」**、反復記号など。

- ## “大 ⇔ 小”ワンショットトグル

  - 押す（またはフリックする）と **次の 1 文字だけ** 小書き（ぁぃ… / ゃゅょ / ゎ / っ）で出力。
  - 連続適用したい場合は長押しで **ラッチ**（再押しで解除）にしてもよい。

# 2) 出力ルール（合成仕様）

- ## 基本出力

  - 行（子音）× 列（母音）で **あ行〜ら行**は `a/i/u/e/o` に対応。

- ## 濁点・半濁点

  - 直前の 1 文字に「゛」「゜」を適用して置換（事前にテーブル持ち）。

    - 例：か → が、た → だ、は → ば、は＋゜ → ぱ、う → ゔ（対応可）。

- ## 小書きの出力

  - “大 ⇔ 小”有効時または長押しポップアップから：

    - ぁぃぅぇぉ / ゃゅょ / っ / ゎ を出力。
    - **つ行の小書き**は っ。や行は ゃゅょ。わ行は ゎ。

- ## 拗音結合（ようおん）

  - 直前が **i 段の子音＋母音**（き/ぎ/し/じ/ち/ぢ/に/ひ/び/ぴ/み/り など）のとき、
    次に **小 ゃ/ゅ/ょ** が来たら 1 文字に結合：き＋ゃ →**きゃ**。

    - 実装は「最後の 1 文字を見て、`YoonAllowed` フラグが立っていれば結合」。

- ## 促音（っ）

  - \*\*小 つ（っ）\*\*は子音の重ねとして扱い、次の子音開始語と結合（ローマ字 IME 的連打は不要）。
  - 単体表示も可能（句読点前など）。

- ## 長音（ー）

  - わ/んキーの右フリックで出力（カタカナ時に多用）。

- ## 変換レイヤ

  - ひらがな / カタカナ / 英数 / 記号はモード切替キーでトグル（本仕様の配列は **ひらがな**）。

# 3) 12 キーかな配列（方向＝上 i / 右 u / 下 e / 左 o / 中央 a）

```
[1,1] あ:  i=い  u=う  e=え  o=お  a=あ
[2,1] か:  き     く     け     こ     か
[3,1] さ:  し     す     せ     そ     さ

[1,2] た:  ち     つ     て     と     た
[2,2] な:  に     ぬ     ね     の     な
[3,2] は:  ひ     ふ     へ     ほ     は

[1,3] ま:  み     む     め     も     ま
[2,3] や:  ←=（  ↑=ゆ  →=）  ↓=よ  a=や  （小モードで中心/↑/↓=ゃゅょ）
[3,3] ら:  り     る     れ     ろ     ら

[1,4] 大⇔小: トグルキー（ワンショット/ラッチ）
[2,4] ん/わ列:  i=わ  u=ー  e=〜  o=を  a=ん
[3,4] 記号:  i=？  u=！  e=…  o=。  a=、   （好みに合わせて入替可）
```

> 画像の下段中央キーの表記（**ん / わ / ー / ～ / を**）に合わせて、
> 中央＝ん／上＝わ／右＝ー／下＝〜／左＝を としています。

- 本実装では **や行の左右** を括弧入力（`←=（`, `→=）`）に固定。
  “大 ⇔ 小”が有効でも括弧は維持され、中心/↑/↓ だけが **ゃ/ゅ/ょ** に切り替わります。

# 4) ダイアクリティック変換表（抜粋）

- 濁点「゛」: か → が, き → ぎ, く → ぐ, け → げ, こ → ご / さ → ざ… / た → だ… / は → ば… / う → ゔ
- 半濁点「゜」: は → ぱ, ひ → ぴ, ふ → ぷ, へ → ぺ, ほ → ぽ
- 片仮名モードでは同様に カ → ガ, ﾊ → ﾊﾟ 等。

# 5) 機械可読レイアウト（JSON 例：KanaFlickLayout v1）

```json
{
  "name": "KanaFlickLayout.v1",
  "directionMap": {
    "up": "i",
    "right": "u",
    "down": "e",
    "left": "o",
    "center": "a"
  },
  "keys": [
    {
      "id": "A",
      "row": 1,
      "col": 1,
      "label": "あ",
      "flick": { "a": "あ", "i": "い", "u": "う", "e": "え", "o": "お" }
    },

    {
      "id": "KA",
      "row": 1,
      "col": 2,
      "label": "か",
      "flick": { "a": "か", "i": "き", "u": "く", "e": "け", "o": "こ" },
      "voicable": true
    },

    {
      "id": "SA",
      "row": 1,
      "col": 3,
      "label": "さ",
      "flick": { "a": "さ", "i": "し", "u": "す", "e": "せ", "o": "そ" },
      "voicable": true
    },

    {
      "id": "TA",
      "row": 2,
      "col": 1,
      "label": "た",
      "flick": { "a": "た", "i": "ち", "u": "つ", "e": "て", "o": "と" },
      "voicable": true,
      "smallVariant": { "u": "っ" }
    },

    {
      "id": "NA",
      "row": 2,
      "col": 2,
      "label": "な",
      "flick": { "a": "な", "i": "に", "u": "ぬ", "e": "ね", "o": "の" }
    },

    {
      "id": "HA",
      "row": 2,
      "col": 3,
      "label": "は",
      "flick": { "a": "は", "i": "ひ", "u": "ふ", "e": "へ", "o": "ほ" },
      "voicable": true,
      "handakuten": true
    },

    {
      "id": "MA",
      "row": 3,
      "col": 1,
      "label": "ま",
      "flick": { "a": "ま", "i": "み", "u": "む", "e": "め", "o": "も" }
    },

    {
      "id": "YA",
      "row": 3,
      "col": 2,
      "label": "や",
      "flick": { "a": "や", "i": "ゆ", "u": ")", "e": "よ", "o": "(" },
      "smallMode": { "a": "ゃ", "i": "ゅ", "e": "ょ" },
      "yoonSource": true
    },

    {
      "id": "RA",
      "row": 3,
      "col": 3,
      "label": "ら",
      "flick": { "a": "ら", "i": "り", "u": "る", "e": "れ", "o": "ろ" }
    },

    {
      "id": "SMALL",
      "row": 4,
      "col": 1,
      "label": "大⇔小",
      "action": "toggleSmall"
    },

    {
      "id": "N_WA",
      "row": 4,
      "col": 2,
      "label": "ん/わ/ー/～/を",
      "flick": { "a": "ん", "i": "わ", "u": "ー", "e": "〜", "o": "を" },
      "smallMode": { "i": "ゎ" }
    },

    {
      "id": "PUNC",
      "row": 4,
      "col": 3,
      "label": "、？！…。",
      "flick": { "a": "、", "i": "？", "u": "！", "e": "…", "o": "。" }
    }
  ],
  "dakutenMap": {
    "か": "が",
    "き": "ぎ",
    "く": "ぐ",
    "け": "げ",
    "こ": "ご",
    "さ": "ざ",
    "し": "じ",
    "す": "ず",
    "せ": "ぜ",
    "そ": "ぞ",
    "た": "だ",
    "ち": "ぢ",
    "つ": "づ",
    "て": "で",
    "と": "ど",
    "は": "ば",
    "ひ": "び",
    "ふ": "ぶ",
    "へ": "べ",
    "ほ": "ぼ",
    "う": "ゔ"
  },
  "handakutenMap": {
    "は": "ぱ",
    "ひ": "ぴ",
    "ふ": "ぷ",
    "へ": "ぺ",
    "ほ": "ぽ"
  },
  "yoonAllowed": [
    "き",
    "ぎ",
    "し",
    "じ",
    "ち",
    "ぢ",
    "に",
    "ひ",
    "び",
    "ぴ",
    "み",
    "り"
  ],
  "smallTable": {
    "あ": "ぁ",
    "い": "ぃ",
    "う": "ぅ",
    "え": "ぇ",
    "お": "ぉ",
    "や": "ゃ",
    "ゆ": "ゅ",
    "よ": "ょ",
    "つ": "っ",
    "わ": "ゎ"
  }
}
```

# 6) 合成ロジック（擬似コード）

```pseudo
state {
  smallOneShot = false   // 大⇔小の一発適用
  lastChar = ""          // 直前の確定1文字
}

onKeyGesture(keyId, direction):
  if keyId == SMALL:
     smallOneShot = toggleOrLatch()
     return

  ch = layout.keys[keyId].flick[dirToVowel(direction)]

  // 小書き適用
  if smallOneShot and ch in smallTable.baseKeys:
     ch = smallTable[ch]
     smallOneShot = false

  // YAキー特例（小書き直出し）
  if keyId == YA and (direction in {center, up, down}) and smallOneShot:
     ch = {"center":"ゃ","up":"ゅ","down":"ょ"}[direction]
     smallOneShot = false

  // 拗音結合
  if ch in {"ゃ","ゅ","ょ"} and lastChar in yoonAllowed:
     output = combine(lastChar, ch)  // き + ゃ -> きゃ
     replaceLast(output)
     lastChar = output[-1]           // 後方参照用
     return

  // 濁点/半濁点（長押し選択時）
  if ch == "゛" or ch == "゜":
     mapped = (ch=="゛") ? dakutenMap[lastChar] : handakutenMap[lastChar]
     if mapped:
        replaceLast(mapped)
        lastChar = mapped
        return
     else:
        // 単独記号として出す
        insert(ch); lastChar = ch; return

  insert(ch)
  lastChar = ch
```

# 7) 推奨 UI/UX

- フリックの方角ガイド（扇形）を「押下中のみ」出す。
- 長押しポップアップに **゛/゜/小/ゎ/っ** をまとめて表示。
- “大 ⇔ 小”は **次の 1 打のみ適用** が直感的。長押しでラッチ可。
- 設定で「中央タップ連打で aiueo を順送り」モードも用意可能（非デフォ）。
